#
# Build Deploy file for Docker container
#

name: Generic Database Deploy Step

defaults:
  run:
    working-directory: .

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      docker_file:
        required: false
        default: "Dockerfile"
        type: string
      project_name:
        required: true
        type: string

jobs:
  deploy:

    # Timeout for the job
    timeout-minutes: 15

    # Static variables used in the workflow
    env:
      TIMESTAMP: ${{ github.sha }}
      INTERNAL_PORT: 3306
      EXTERNAL_PORT: ${{ secrets.DATABASE_PORT }}

    # To be able to deploy on the local server
    runs-on: self-hosted

    environment: ${{ inputs.environment }}

    steps:

    - name: Convert Docker name to lowercase
      id: convert_to_lowercase
      run: |
        UPPERCASE_VAR="${{ inputs.project_name }}"
        DOCKER_NAME="${UPPERCASE_VAR,,}" # The ,, converts to lowercase
        echo "DOCKER_NAME=$DOCKER_NAME" >> $GITHUB_OUTPUT

    - name: Checkout repository
      uses: actions/checkout@v4      

    - name: Stop old Docker container
      run:
        docker stop ${{ steps.convert_to_lowercase.outputs.DOCKER_NAME }}-${{ inputs.environment }} || true

    - name: Delete old Docker container
      run:
        docker rm ${{ steps.convert_to_lowercase.outputs.DOCKER_NAME }}-${{ inputs.environment }} || true

    - name: Create mariaDB volume
      run:
        docker volume create ${{ steps.convert_to_lowercase.outputs.DOCKER_NAME }}-${{ inputs.environment }}-data

    - name: Run Docker container
      run:
        docker run -p ${{ env.EXTERNAL_PORT }}:${{ env.INTERNAL_PORT }} 
        --name ${{ steps.convert_to_lowercase.outputs.DOCKER_NAME }}-${{ inputs.environment }} 
        --volume ${{ steps.convert_to_lowercase.outputs.DOCKER_NAME }}-${{ inputs.environment }}-data:/var/lib/mysql
        --env MARIADB_ROOT_PASSWORD='${{ secrets.DATABASE_PASSWORD }}' 
        --restart unless-stopped
        --detach 
        mariadb:10.4
